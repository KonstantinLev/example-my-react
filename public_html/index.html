<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="main.css">
  <title>Demo Crypto</title>
</head>
<body>

  <div id="root"></div>

  <script>

    const api = {
        get (url) {
            switch (url) {
                case '/coins':
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            resolve([
                                {
                                    id: 1,
                                    name: 'Super Coin',
                                    description: 'Super coin for you',
                                    price: 256.36,
                                },
                                {
                                    id: 2,
                                    name: 'Awesome Coin AWM',
                                    description: 'Cosmic coin. Available in ru zone',
                                    price: 1025.32,
                                },
                            ])
                        }, 1000)
                    })
                default:
                    throw new Error('Unknown address')
            }
        }
    }

    const stream = {
        subscribe (channel, listener) {
            const match = /price-(\d+)/.exec(channel)
            if (match) {
                setInterval(() => {
                    listener({
                        id: parseInt(match[1]),
                        price: Math.round((Math.random() * 10 + 40))
                    })
                }, 500)
            }
        }
    }

    //=======================

    let state = {
        time: new Date(),
        coins: null
    }

    //=======================

    function App({ state }) {
        const node = document.createElement('div')
        node.className = 'app'

        node.append(Header())
        node.append(Clock({ time: state.time }))
        node.append(Coins({ coins: state.coins }))

        return node
    }

    function Header() {
        const node = document.createElement('header')
        node.className = 'header'

        node.append(Logo())
        return node
    }

    function Logo() {
        const node = document.createElement('img')
        node.className = 'logo'
        node.src = 'logo.png'
        return node
    }

    function Clock({ time }) {
        const node = document.createElement('div')
        node.className = 'clock'

        const value = document.createElement('span')
        value.className = 'value'
        value.innerText = time.toLocaleString()

        node.append(value)

        const icon = document.createElement('span')

        if (time.getHours() >= 7 && time.getHours() <= 21) {
            icon.className = 'icon day'
        } else {
            icon.className = 'icon night'
        }

        node.append(icon)

        return node
    }

    function Loading () {
        const node = document.createElement('div')
        node.className = 'loading'
        node.innerText = 'Loading...'
        return node
    }

    function Coins({ coins }) {
        if (coins === null) {
            return Loading()
        }

        const node = document.createElement('div')
        node.className = 'coins'

        coins.forEach((coin) => {
            node.append(Coin({ coin }))
        })

        return node
    }

    function Coin({ coin }) {
        const node = document.createElement('div')
        node.className = 'coin'

        const name = document.createElement('h2')
        name.innerText = coin.name
        node.append(name)

        const info = document.createElement('div')
        info.className = 'info'

        const description = document.createElement('p')
        description.innerText = coin.description
        info.append(description)

        const price = document.createElement('div')
        price.className = 'price'
        price.innerText = coin.price
        info.append(price)

        node.append(info)

        return node
    }

    //=======================

    // render(
    //     App({ state }),
    //     document.getElementById('root')
    // )

    function renderView (state) {
        render(
            App({ state }),
            document.getElementById('root')
        )
    }

    renderView(state)

    //=======================

    setInterval(() => {
        state = {
            ...state,
            time: new Date()
        }

        renderView(state)

    }, 1000)

    api.get('/coins').then((coins) => {
        state = {
            ...state,
            coins
        }
        renderView(state)

        const onPrice = (data) => {
            state = {
                ...state,
                coins: state.coins.map((coin) => {
                    if (coin.id === data.id) {
                        return {
                            ...coin,
                            price: data.price
                        }
                    }
                    return coin
                })
            }
        renderView(state)
      }

      coins.forEach((coin) => {
          stream.subscribe(`price-${coin.id}`, onPrice)
      })
    })

    //=======================

    function render (newDom, realDomRoot) {
        realDomRoot.innerHTML = ''
        realDomRoot.append(newDom)
    }

  </script>
</body>
</html>
